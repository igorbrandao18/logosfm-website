name: Build and Deploy Docker Image

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t logosfm-website:latest .
      
      - name: Test Docker image
        run: |
          docker run -d -p 7777:8000 --name test-container logosfm-website:latest
          sleep 5
          curl -f http://localhost:7777 || exit 1
          docker stop test-container
          docker rm test-container

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
      
      - name: Copy files to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          set -e
          
          # Criar diretório no servidor se não existir (com timeout)
          echo "Creating directory on server..."
          timeout 30 sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SERVER_USER@$SERVER_IP "mkdir -p /opt/logosfm-website" || exit 1
          
          # Criar arquivo tar em diretório temporário para evitar conflito
          echo "Creating tarball..."
          mkdir -p /tmp/deploy
          tar --exclude='.git' --exclude='__MACOSX' --exclude='node_modules' \
              --exclude='.github' -czf /tmp/deploy/site-files.tar.gz .
          
          # Copiar arquivo tar para o servidor (com timeout)
          echo "Copying files to server..."
          timeout 120 sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            /tmp/deploy/site-files.tar.gz \
            $SERVER_USER@$SERVER_IP:/opt/logosfm-website/ || exit 1
          
          # Extrair arquivos no servidor (com timeout)
          echo "Extracting files on server..."
          timeout 60 sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SERVER_USER@$SERVER_IP "cd /opt/logosfm-website && tar -xzf site-files.tar.gz && rm site-files.tar.gz" || exit 1
          
          # Limpar arquivo tar local
          rm -rf /tmp/deploy
          echo "Files copied successfully!"
      
      - name: Deploy site on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          set -e
          # Fazer build e restart do container do site no servidor
          timeout 300 sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SERVER_USER@$SERVER_IP << 'EOF'
            cd /opt/logosfm-website
            
            # Verificar se docker-compose está instalado, se não, instalar
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing docker-compose..."
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi
            
            # Parar containers existentes do site
            docker-compose down || true
            
            # Build e start do site
            docker-compose build --no-cache
            docker-compose up -d
            
            # Verificar status do site
            docker-compose ps
            echo "Site deploy completed successfully!"
          EOF
      
      - name: Verify deployment
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sleep 5
          
          # Verificar site (porta 7777)
          echo "Verifying site on port 7777..."
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "curl -f http://localhost:7777 || exit 1"
          echo "Site verified successfully!"
          
          echo "Deployment verification completed!"

